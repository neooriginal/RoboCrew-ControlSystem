{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}">
{% endblock %}

{% block content %}
<div class="settings-container">

    <!-- Essential Settings -->
    <div class="settings-section">
        <h2>Essential Settings</h2>
        <div class="settings-grid">

            <!-- HuggingFace -->
            <div class="settings-card">
                <h3>ü§ó HuggingFace Hub</h3>
                <p style="color:#888; font-size:0.85em; margin-bottom:15px;">Connect your HuggingFace account for
                    dataset/policy sync.</p>
                <div id="hfAuthPanel">
                    <div style="color:#666; text-align:center;">Checking...</div>
                </div>
            </div>

            <!-- Hardware Ports -->
            <div class="settings-card">
                <h3>üîå Hardware</h3>

                <div class="form-group">
                    <label>Main Camera</label>
                    <div class="port-row">
                        <select id="cfg_CAMERA_PORT" onchange="onCameraChange('CAMERA_PORT', this.value)"></select>
                        <button type="button" class="manual-btn" onclick="toggleManual('CAMERA_PORT')">‚úèÔ∏è</button>
                    </div>
                    <input type="text" id="cfg_CAMERA_PORT_manual" class="manual-input"
                        placeholder="/dev/video0 or index">
                    <div class="camera-preview" id="preview_CAMERA_PORT"><span>Select to preview</span></div>
                </div>

                <div class="form-group">
                    <label>Right Hand Camera</label>
                    <div class="port-row">
                        <select id="cfg_CAMERA_RIGHT_PORT"
                            onchange="onCameraChange('CAMERA_RIGHT_PORT', this.value)"></select>
                        <button type="button" class="manual-btn" onclick="toggleManual('CAMERA_RIGHT_PORT')">‚úèÔ∏è</button>
                    </div>
                    <input type="text" id="cfg_CAMERA_RIGHT_PORT_manual" class="manual-input"
                        placeholder="/dev/video0 or index">
                    <div class="camera-preview" id="preview_CAMERA_RIGHT_PORT"><span>Select to preview</span></div>
                </div>

                <div class="form-group">
                    <label>Wheel Controller USB</label>
                    <div class="port-row">
                        <select id="cfg_WHEEL_USB"></select>
                        <button type="button" class="manual-btn" onclick="toggleManual('WHEEL_USB')">‚úèÔ∏è</button>
                    </div>
                    <input type="text" id="cfg_WHEEL_USB_manual" class="manual-input" placeholder="/dev/ttyACM0">
                </div>

                <div class="form-group">
                    <label>Head Controller USB</label>
                    <div class="port-row">
                        <select id="cfg_HEAD_USB"></select>
                        <button type="button" class="manual-btn" onclick="toggleManual('HEAD_USB')">‚úèÔ∏è</button>
                    </div>
                    <input type="text" id="cfg_HEAD_USB_manual" class="manual-input" placeholder="/dev/ttyACM1">
                </div>
            </div>

            <!-- Web Server -->
            <div class="settings-card">
                <h3>üåê Web Server</h3>
                <div class="form-group">
                    <label>Port</label>
                    <input type="number" id="cfg_WEB_PORT" min="1024" max="65535" onchange="onWebPortChange()">
                    <div class="hint">Default: 5000. Requires restart.</div>
                </div>
            </div>

            <!-- Lidar Sensor -->
            <div class="settings-card">
                <h3>üì° Lidar Sensor</h3>
                <p style="color:#888; font-size:0.85em; margin-bottom:15px;">TF-Luna single-point distance sensor.
                    Auto-detects if connected.</p>

                <div class="form-group">
                    <label>Protocol</label>
                    <select id="cfg_LIDAR_PROTOCOL" onchange="onLidarProtocolChange()">
                        <option value="uart">UART (Serial)</option>
                        <option value="i2c">I2C</option>
                    </select>
                </div>

                <div class="form-group" id="lidarPortGroup">
                    <label>Serial Port</label>
                    <div class="port-row">
                        <select id="cfg_LIDAR_PORT"></select>
                        <button type="button" class="manual-btn" onclick="toggleManual('LIDAR_PORT')">‚úèÔ∏è</button>
                    </div>
                    <input type="text" id="cfg_LIDAR_PORT_manual" class="manual-input" placeholder="/dev/ttyUSB0">
                </div>

                <div class="form-group" id="lidarBaudGroup">
                    <label>Baud Rate</label>
                    <select id="cfg_LIDAR_BAUD_RATE">
                        <option value="9600">9600</option>
                        <option value="19200">19200</option>
                        <option value="38400">38400</option>
                        <option value="57600">57600</option>
                        <option value="115200">115200</option>
                        <option value="230400">230400</option>
                        <option value="460800">460800</option>
                    </select>
                    <div class="hint">TF-Luna default: 115200</div>
                </div>

                <div class="form-group" id="lidarI2CGroup" style="display: none;">
                    <label>I2C Address (decimal)</label>
                    <input type="number" id="cfg_LIDAR_I2C_ADDRESS" min="1" max="127" value="16">
                    <div class="hint">TF-Luna default: 16 (0x10)</div>
                </div>
            </div>

            <!-- TTS -->
            <div class="settings-card">
                <h3>üó£Ô∏è Text-to-Speech</h3>
                <div class="form-group">
                    <div class="toggle-container">
                        <label class="toggle">
                            <input type="checkbox" id="cfg_TTS_ENABLED">
                            <span class="slider"></span>
                        </label>
                        <span>Enable TTS</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Audio Device (ALSA)</label>
                    <input type="text" id="cfg_TTS_AUDIO_DEVICE" placeholder="plughw:1,0">
                </div>
                <div class="form-group">
                    <label>Google TLD (Voice Accent)</label>
                    <select id="cfg_TTS_TLD">
                        <option value="com">com (US)</option>
                        <option value="co.uk">co.uk (UK)</option>
                        <option value="com.au">com.au (Australia)</option>
                        <option value="co.in">co.in (India)</option>
                        <option value="ca">ca (Canada)</option>
                    </select>
                </div>
            </div>

            <!-- AI Configuration -->
            <div class="settings-card">
                <h3>üß† AI Configuration</h3>
                <div class="form-group">
                    <label>OpenAI API Key</label>
                    <div class="input-with-icon">
                        <input type="password" id="cfg_OPENAI_API_KEY" placeholder="sk-..." onchange="markDirty()">
                        <button class="btn-icon" onclick="togglePassword('cfg_OPENAI_API_KEY')" title="Show/Hide">
                            üëÅÔ∏è
                        </button>
                    </div>
                    <div class="hint">Required for AI Agent navigation and reasoning.</div>
                </div>
            </div>

            <!-- Account Settings -->
            <div class="settings-card">
                <h3>üîê Account</h3>
                <div class="form-group">
                    <label>Current Password</label>
                    <input type="password" id="current_password" placeholder="Enter current password">
                </div>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" id="new_password" placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label>Confirm New Password</label>
                    <input type="password" id="confirm_new_password" placeholder="Confirm new password">
                </div>
                <button class="btn btn-secondary" onclick="changePassword()" style="margin-top: 10px;">
                    üîë Change Password
                </button>
                <div id="password-result" style="margin-top: 10px; font-size: 0.9em;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Settings -->
<button class="advanced-toggle" onclick="toggleAdvanced()">
    <span id="adv-arrow">‚ñ∂</span> Advanced Settings
</button>

<div id="advanced-content" class="advanced-content">
    <div class="settings-grid">

        <!-- Camera Capture -->
        <div class="settings-card">
            <h3>üì∑ Camera Capture</h3>
            <div class="form-group">
                <label>Width</label>
                <input type="number" id="cfg_CAMERA_WIDTH" min="320" max="4096">
            </div>
            <div class="form-group">
                <label>Height</label>
                <input type="number" id="cfg_CAMERA_HEIGHT" min="240" max="2160">
            </div>
            <div class="form-group">
                <label>Buffer Size</label>
                <input type="number" id="cfg_CAMERA_BUFFER_SIZE" min="1" max="10">
            </div>
        </div>

        <!-- Video Stream -->
        <div class="settings-card">
            <h3>üì∫ Video Stream</h3>
            <div class="form-group">
                <label>Width</label>
                <input type="number" id="cfg_STREAM_WIDTH" min="160" max="1920">
            </div>
            <div class="form-group">
                <label>Height</label>
                <input type="number" id="cfg_STREAM_HEIGHT" min="120" max="1080">
            </div>
            <div class="form-group">
                <label>JPEG Quality: <span id="quality_val">50</span></label>
                <input type="range" id="cfg_STREAM_JPEG_QUALITY" min="10" max="100"
                    oninput="document.getElementById('quality_val').innerText=this.value">
            </div>
        </div>

        <!-- Obstacle Detection -->
        <div class="settings-card">
            <h3>üöß Obstacle Detection</h3>
            <div class="form-group">
                <label>Sobel Threshold</label>
                <input type="number" id="cfg_OBSTACLE_SOBEL_THRESHOLD" min="1" max="255">
                <div class="hint">Lower = more sensitive. Default: 45</div>
            </div>
            <div class="form-group">
                <label>Threshold Ratio</label>
                <input type="number" id="cfg_OBSTACLE_THRESHOLD_RATIO" step="0.01" min="0" max="1">
                <div class="hint">0.0=top, 1.0=bottom. Default: 0.875</div>
            </div>
        </div>

        <!-- Control Timings -->
        <div class="settings-card">
            <h3>‚è±Ô∏è Control Timings</h3>
            <div class="form-group">
                <label>Movement Loop Interval (s)</label>
                <input type="number" id="cfg_MOVEMENT_LOOP_INTERVAL" step="0.01" min="0.01" max="1">
            </div>
            <div class="form-group">
                <label>Head Update Interval (ms)</label>
                <input type="number" id="cfg_HEAD_UPDATE_INTERVAL" min="10" max="500">
            </div>
            <div class="form-group">
                <label>Arm Update Interval (ms)</label>
                <input type="number" id="cfg_ARM_UPDATE_INTERVAL" min="10" max="500">
            </div>
        </div>

        <!-- Arm Sensitivity -->
        <div class="settings-card">
            <h3>ü¶æ Arm Sensitivity</h3>
            <div class="form-group">
                <label>XY Sensitivity</label>
                <input type="number" id="cfg_ARM_XY_SENSITIVITY" step="0.01" min="0.01" max="1">
            </div>
            <div class="form-group">
                <label>Wrist Sensitivity</label>
                <input type="number" id="cfg_ARM_WRIST_SENSITIVITY" step="0.1" min="0.1" max="5">
            </div>
            <div class="form-group">
                <label>Shoulder Pan Step</label>
                <input type="number" id="cfg_ARM_SHOULDER_PAN_STEP" step="0.1" min="0.1" max="10">
            </div>
            <div class="form-group">
                <label>Wrist Flex Step</label>
                <input type="number" id="cfg_ARM_WRIST_FLEX_STEP" step="0.1" min="0.1" max="10">
            </div>
        </div>

        <!-- Safety -->
        <div class="settings-card">
            <h3>üõ°Ô∏è Safety</h3>
            <div class="form-group">
                <label>Remote Timeout (s)</label>
                <input type="number" id="cfg_REMOTE_TIMEOUT" step="0.1" min="0.1" max="5">
            </div>
            <div class="form-group">
                <label>AI Min Brightness</label>
                <input type="number" id="cfg_AI_MIN_BRIGHTNESS" min="0" max="255">
            </div>
            <div class="form-group">
                <label>Stall Load Threshold</label>
                <input type="number" id="cfg_STALL_LOAD_THRESHOLD" min="100" max="2000">
            </div>
            <div class="form-group">
                <label>Stall Check Interval (s)</label>
                <input type="number" id="cfg_STALL_CHECK_INTERVAL" step="0.1" min="0.1" max="5">
            </div>
        </div>

        <!-- VR -->
        <div class="settings-card">
            <h3>ü•Ω VR Control</h3>
            <div class="form-group">
                <label>WebSocket Port</label>
                <input type="number" id="cfg_VR_WEBSOCKET_PORT" min="1024" max="65535">
            </div>
            <div class="form-group">
                <label>Robot Scale</label>
                <input type="number" id="cfg_VR_TO_ROBOT_SCALE" step="0.1" min="0.1" max="5">
            </div>
            <div class="form-group">
                <label>Send Interval (s)</label>
                <input type="number" id="cfg_VR_SEND_INTERVAL" step="0.01" min="0.01" max="1">
            </div>
        </div>

    </div>
</div>

<!-- Save Bar -->
<div class="save-bar">
    <div class="restart-warning" id="restart-warning">
        ‚ö†Ô∏è Restart required. New URL: <strong id="new-url"></strong>
    </div>
    <button class="btn btn-primary" onclick="saveConfig()"
        style="box-shadow: 0 4px 20px rgba(0, 242, 255, 0.4); padding: 12px 24px; font-size: 1rem;">üíæ Save
        Settings</button>
</div>

</div>

<div class="toast" id="toast">Settings saved!</div>
{% endblock %}

{% block scripts %}
<script>
    let config = {};
    let defaults = {};
    let ports = { serial: [], video: [] };
    let originalWebPort = null;

    document.addEventListener('DOMContentLoaded', async () => {
        await loadPorts();
        await loadConfig();
        checkAuthStatus();
    });

    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        if (input.type === "password") {
            input.type = "text";
        } else {
            input.type = "password";
        }
    }

    async function changePassword() {
        const current = document.getElementById('current_password').value;
        const newPw = document.getElementById('new_password').value;
        const confirm = document.getElementById('confirm_new_password').value;
        const result = document.getElementById('password-result');

        if (newPw !== confirm) {
            result.innerHTML = '<span style="color: #ff2a2a;">Passwords do not match</span>';
            return;
        }

        if (newPw.length < 4) {
            result.innerHTML = '<span style="color: #ff2a2a;">New password too short</span>';
            return;
        }

        try {
            const res = await fetch('/api/auth/password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ current_password: current, new_password: newPw })
            });
            const data = await res.json();

            if (res.ok) {
                result.innerHTML = '<span style="color: #00ff9d;">Password changed successfully!</span>';
                document.getElementById('current_password').value = '';
                document.getElementById('new_password').value = '';
                document.getElementById('confirm_new_password').value = '';
            } else {
                result.innerHTML = '<span style="color: #ff2a2a;">' + (data.error || 'Failed') + '</span>';
            }
        } catch (e) {
            result.innerHTML = '<span style="color: #ff2a2a;">Connection error</span>';
        }
    }

    async function loadConfig() {
        const res = await fetch('/api/config');
        const data = await res.json();
        config = data.config;
        defaults = data.defaults;
        originalWebPort = config.WEB_PORT;

        // Populate all fields
        for (const [key, value] of Object.entries(config)) {
            const el = document.getElementById(`cfg_${key}`);
            if (!el) continue;

            if (el.type === 'checkbox') {
                el.checked = value;
            } else if (el.tagName === 'SELECT') {
                populateSelect(el, key, value);
            } else {
                el.value = value;
            }
        }

        // Update quality display
        document.getElementById('quality_val').innerText = config.STREAM_JPEG_QUALITY || 50;

        // Initialize lidar UI state after config loaded
        initLidarUI();
    }

    async function loadPorts() {
        try {
            const res = await fetch('/api/ports');
            ports = await res.json();
        } catch (e) {
            console.error('Failed to load ports', e);
        }
    }

    function populateSelect(el, key, currentValue) {
        el.innerHTML = '';

        const isVideo = key.includes('CAMERA');
        const isSerial = key.includes('USB') || key === 'LIDAR_PORT';

        const list = isVideo ? ports.video : (isSerial ? ports.serial : []);

        // Add discovered options
        list.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.device;
            opt.textContent = p.description;
            if (p.device === currentValue) opt.selected = true;
            el.appendChild(opt);
        });

        // Add current value if not in list
        if (currentValue && !list.find(p => p.device === currentValue)) {
            const opt = document.createElement('option');
            opt.value = currentValue;
            opt.textContent = `${currentValue} (current)`;
            opt.selected = true;
            el.prepend(opt);
        }

        // Add empty option if nothing selected
        if (!currentValue && list.length === 0) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'No devices found';
            el.appendChild(opt);
        }
    }

    function toggleManual(key) {
        const manualInput = document.getElementById(`cfg_${key}_manual`);
        manualInput.classList.toggle('visible');
        if (manualInput.classList.contains('visible')) {
            manualInput.value = document.getElementById(`cfg_${key}`).value;
            manualInput.focus();
        }
    }

    function onCameraChange(key, value) {
        if (!value) return;

        const previewEl = document.getElementById(`preview_${key}`);
        previewEl.innerHTML = '<span>Loading...</span>';

        // URL encode the path
        const encodedPort = encodeURIComponent(value);
        const img = new Image();
        img.onload = () => { previewEl.innerHTML = ''; previewEl.appendChild(img); };
        img.onerror = () => { previewEl.innerHTML = '<span style="color:#ff5555">Failed</span>'; };
        img.src = `/api/camera/preview/${encodedPort}?t=${Date.now()}`;
    }

    function onWebPortChange() {
        const newPort = parseInt(document.getElementById('cfg_WEB_PORT').value);
        const warning = document.getElementById('restart-warning');
        const urlEl = document.getElementById('new-url');

        if (newPort !== originalWebPort) {
            const newUrl = `${window.location.protocol}//${window.location.hostname}:${newPort}/`;
            urlEl.textContent = newUrl;
            warning.classList.add('visible');
        } else {
            warning.classList.remove('visible');
        }
    }

    function toggleAdvanced() {
        const content = document.getElementById('advanced-content');
        const arrow = document.getElementById('adv-arrow');
        content.classList.toggle('visible');
        arrow.textContent = content.classList.contains('visible') ? '‚ñº' : '‚ñ∂';
    }

    function onLidarProtocolChange() {
        const protocol = document.getElementById('cfg_LIDAR_PROTOCOL').value;
        const isUart = protocol === 'uart';
        document.getElementById('lidarPortGroup').style.display = isUart ? 'block' : 'none';
        document.getElementById('lidarBaudGroup').style.display = isUart ? 'block' : 'none';
        document.getElementById('lidarI2CGroup').style.display = isUart ? 'none' : 'block';
    }

    function initLidarUI() {
        onLidarProtocolChange();
    }

    async function saveConfig() {
        // Gather all values
        const data = {};

        for (const key of Object.keys(defaults)) {
            const el = document.getElementById(`cfg_${key}`);
            const manualEl = document.getElementById(`cfg_${key}_manual`);

            if (!el) continue;

            let value;

            // Check manual input first
            if (manualEl && manualEl.classList.contains('visible') && manualEl.value.trim()) {
                value = manualEl.value.trim();
            } else if (el.type === 'checkbox') {
                value = el.checked;
            } else if (el.type === 'number' || el.type === 'range') {
                value = parseFloat(el.value);
            } else if (key === 'LIDAR_BAUD_RATE') {
                // Baud rate from select needs to be integer
                value = parseInt(el.value, 10);
            } else {
                value = el.value;
            }

            data[key] = value;
        }

        try {
            const res = await fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                showToast('Settings saved!');
                originalWebPort = data.WEB_PORT;
                onWebPortChange();
            } else {
                showToast('Save failed!');
            }
        } catch (e) {
            showToast('Error: ' + e);
        }
    }

    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.classList.add('visible');
        setTimeout(() => toast.classList.remove('visible'), 2500);
    }

    // HuggingFace Auth (from original)
    async function checkAuthStatus() {
        try {
            const res = await fetch('/api/training/auth');
            const data = await res.json();
            const panel = document.getElementById('hfAuthPanel');

            if (data.username) {
                panel.innerHTML = `
                <div style="background:#252525; padding:12px; border-radius:4px; border-left: 3px solid #00ff9d; margin-bottom:12px;">
                    <div style="font-size:0.8em; color:#aaa;">Logged in as</div>
                    <div style="font-weight:bold; color:#fff;">${data.username}</div>
                </div>
                <button class="btn btn-danger" onclick="hfLogout()" style="width:100%; font-size:0.85em;">Disconnect</button>
            `;
            } else {
                panel.innerHTML = `
                <input type="password" id="hfToken" placeholder="hf_..." style="margin-bottom:10px;">
                <button class="btn btn-primary" onclick="hfLogin()" style="width:100%; font-size:0.85em;">Login</button>
                <div style="margin-top:8px; font-size:0.75em; color:#666; text-align:center;">Token needs "Write" access.</div>
            `;
            }
        } catch (e) {
            document.getElementById('hfAuthPanel').innerHTML = "<div style='color:red'>Failed to check auth.</div>";
        }
    }

    async function hfLogin() {
        const token = document.getElementById('hfToken').value.trim();
        if (!token) return alert("Enter token");

        const res = await fetch('/api/training/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token })
        });
        const data = await res.json();
        if (data.status === 'ok') checkAuthStatus();
        else alert("Failed: " + data.message);
    }

    async function hfLogout() {
        if (!confirm("Disconnect from HuggingFace?")) return;
        await fetch('/api/training/auth/logout', { method: 'POST' });
        checkAuthStatus();
    }
</script>
{% endblock %}
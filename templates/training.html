{% extends "base.html" %}

{% block title %}Training Dashboard (BETA){% endblock %}

{% block head %}
<style>
    .split-view {
        display: flex;
        gap: 20px;
        height: calc(100vh - 80px);
        /* Fill remaining */
    }

    .panel {
        background: #1e1e1e;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 20px;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .panel h2 {
        margin-top: 0;
        color: #ddd;
        border-bottom: 1px solid #333;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .list-container {
        flex: 1;
        overflow-y: auto;
    }

    .item-row {
        background: #2a2a2a;
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .item-row:hover {
        background: #333;
    }

    .status-badge {
        font-size: 0.8em;
        padding: 2px 6px;
        border-radius: 4px;
        background: #444;
        color: #aaa;
    }

    .logs-panel {
        background: #000;
        color: #0f0;
        font-family: monospace;
        padding: 10px;
        overflow-y: auto;
        flex: 1;
        font-size: 0.9em;
        border: 1px solid #333;
    }

    .train-controls {
        background: #252525;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    label {
        display: block;
        margin-bottom: 5px;
        color: #aaa;
        font-size: 0.9em;
    }

    input,
    select {
        width: 100%;
        background: #333;
        border: 1px solid #444;
        color: #fff;
        padding: 8px;
        border-radius: 4px;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div style="padding: 20px;">

    <!-- Active Training Monitor (Top) -->
    <div id="activeJobPanel"
        style="display: none; background: #222; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #444;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0; color: #fff;">üèÉ Active Training Job: <span id="jobName"
                    style="color: #00d2ff;">...</span></h3>
            <button class="btn btn-danger" onclick="stopTraining()">Stop Training</button>
        </div>
        <div class="logs-panel" id="trainingLogs" style="height: 200px;">
            <div>> Waiting for logs...</div>
        </div>
    </div>

    <div class="split-view">
        <!-- Datasets Panel -->
        <div class="panel">
            <h2>HuggingFace Hub</h2>
            <div id="hfAuthPanel" style="background:#252525; padding:10px; border-radius:4px; margin-bottom:15px;">
                Checking login status...
            </div>

            <h2>Remote Workers <span id="workerCount" class="status-badge" style="display:none">0</span></h2>
            <div id="workerPanel" style="background:#252525; padding:10px; border-radius:4px; margin-bottom:15px;">
                <div style="color:#aaa; font-size:0.9em; margin-bottom:10px;">Connect a powerful PC to speed up
                    training.</div>
                <div id="workerList" style="margin-bottom:10px;"></div>
                <div style="display:flex; gap:8px;">
                    <a href="/static/train_remote.bat" download
                        style="flex:1; background:#007acc; color:#fff; padding:8px 12px; border-radius:4px; text-align:center; text-decoration:none; font-size:0.9em;">üì•
                        Windows</a>
                    <a href="/static/train_remote.sh" download
                        style="flex:1; background:#444; color:#fff; padding:8px 12px; border-radius:4px; text-align:center; text-decoration:none; font-size:0.9em;">üì•
                        macOS</a>
                </div>
            </div>

            <h2>Reference Datasets (Local)</h2>
            <div class="train-controls">
                <label>Job Name (Required)</label>
                <input type="text" id="newJobName" placeholder="e.g. policy_test_1">
                <small style="color:#666; display:block; margin-top:-5px; margin-bottom:10px;">Device will be
                    auto-detected.</small>
            </div>
            <div class="list-container" id="datasetList">
                <div style="color: #666; padding: 10px; text-align: center;">Loading datasets...</div>
            </div>
        </div>

        <!-- Trained Policies Panel -->
        <div class="panel">
            <h2>Trained Policies</h2>
            <div class="list-container" id="policyList">
                <div style="color: #666; padding: 10px; text-align: center;">Loading policies...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let isTraining = false;
    let logInterval = null;
    let policyInterval = null;

    async function loadData() {
        checkAuthStatus();

        // Load Datasets
        try {
            const res = await fetch('/api/training/datasets');
            const data = await res.json();
            const container = document.getElementById('datasetList');
            container.innerHTML = '';

            if (data.datasets.length === 0) {
                container.innerHTML = '<div style="color:#666; padding:10px;">No datasets found in logs/datasets/</div>';
            }

            data.datasets.forEach(name => {
                const row = document.createElement('div');
                row.className = 'item-row';
                row.innerHTML = `
                    <span style="font-weight: bold; color: #fff;">üìÑ ${name}</span>
                    <div>
                        <button class="btn btn-sm btn-primary" onclick="requestTrain('${name}')" style="margin-right:8px;">Train ACT</button>
                        <button class="btn btn-sm" onclick="renameDataset('${name}')" style="margin-right:8px; background: #666;">Rename</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteDataset('${name}')" style="padding: 2px 8px;">üóëÔ∏è</button>
                    </div>
                `;
                container.appendChild(row);
            });
        } catch (e) { console.error(e); }

        // Load Policies
        try {
            const res = await fetch('/api/training/policies');
            const data = await res.json();
            const container = document.getElementById('policyList');
            container.innerHTML = '';

            if (data.policies.length === 0) {
                container.innerHTML = '<div style="color:#666; padding:10px;">No policies found in logs/policies/</div>';
            }

            data.policies.forEach(name => {
                const row = document.createElement('div');
                row.className = 'item-row';
                row.innerHTML = `
                    <span style="font-weight: bold; color: #0f0;">üß† ${name}</span>
                    <button class="btn btn-sm btn-success" onclick="runPolicy('${name}')">Run Policy</button>
                `;
                container.appendChild(row);
            });
        } catch (e) { console.error(e); }
    }

    async function renameDataset(oldName) {
        const newName = prompt("Enter new name for dataset '" + oldName + "':", oldName);
        if (!newName || newName === oldName) return;

        try {
            const res = await fetch('/api/training/datasets/rename', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ old_name: oldName, new_name: newName })
            });
            const data = await res.json();
            if (data.status === 'ok') {
                alert("Renamed: " + data.message);
                loadData();
            } else {
                alert("Error: " + data.message);
            }
        } catch (e) { alert("Req error: " + e); }
    }

    async function deleteDataset(name) {
        if (!confirm(`‚ö†Ô∏è PERMANENTLY DELETE '${name}'?\n\nThis will delete:\n1. Local copy in /logs/datasets/\n2. Remote repo on HuggingFace Hub\n\nAre you sure?`)) return;

        try {
            const res = await fetch('/api/training/datasets/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dataset_name: name })
            });
            const data = await res.json();
            if (data.status === 'ok') {
                alert("Deleted: " + data.message);
                loadData();
            } else {
                alert("Error: " + data.message);
            }
        } catch (e) { alert("Req error: " + e); }
    }

    async function requestTrain(datasetName) {
        const jobName = document.getElementById('newJobName').value.trim();

        if (isTraining) {
            alert("A training job is already active.");
            return;
        }

        if (!jobName) {
            alert("Please provide a Job Name for the new policy.");
            document.getElementById('newJobName').focus();
            return;
        }

        let device = 'auto';

        // Remote Worker Logic
        if (window.activeWorkers && window.activeWorkers.length > 0) {
            device = 'remote';
            if (window.activeWorkers.length === 1) {
                let w = window.activeWorkers[0];
                if (!confirm(`üöÄ Train on ${w.gpu}?\n\nDataset: ${datasetName}\nJob: ${jobName}`)) return;
            } else {
                let info = window.activeWorkers.map((w, i) => `${i + 1}. ${w.gpu}`).join('\n');
                let choice = prompt(`Select Worker:\n${info}`);
                if (!choice) return;
            }
        }

        try {
            const res = await fetch('/api/training/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    dataset: datasetName,
                    job_name: jobName,
                    device: device
                })
            });
            const data = await res.json();

            if (data.status === 'ok') {
                startMonitoring();
            } else {
                alert("Error: " + data.error);
            }
        } catch (e) { alert("Req error: " + e); }
    }

    async function pollWorkers() {
        try {
            const res = await fetch('/api/training/worker_status');
            const data = await res.json();
            window.activeWorkers = data.workers || [];

            const list = document.getElementById('workerList');
            const badge = document.getElementById('workerCount');

            if (window.activeWorkers.length > 0) {
                badge.innerText = window.activeWorkers.length;
                badge.style.display = 'inline-block';
                badge.style.background = '#00d2ff';
                badge.style.color = '#000';

                list.innerHTML = window.activeWorkers.map(w => `
                    <div style="background:#333; padding:5px; margin-bottom:5px; border-left:3px solid #0f0; font-size:0.9em;">
                        üñ•Ô∏è <strong>${w.gpu}</strong><br>
                        Status: ${w.status}
                    </div>
                `).join('');
            } else {
                badge.style.display = 'none';
                list.innerHTML = '<div style="color:#666; font-size:0.8em;">No workers connected...</div>';
            }
        } catch (e) { }
    }

    // Poll workers
    setInterval(pollWorkers, 3000);

    // ---- Execution Monitoring ----

    async function stopTraining() {
        if (!confirm("Stop training process?")) return;
        await fetch('/api/training/stop', { method: 'POST' });
    }

    async function startMonitoring() {
        showPanel("training");
        isTraining = true;
        if (logInterval) clearInterval(logInterval);
        logInterval = setInterval(pollTrainingStatus, 1000);
    }

    async function pollTrainingStatus() {
        try {
            const res = await fetch('/api/training/status');
            const data = await res.json();
            isTraining = data.status.is_training;

            // Logs
            const logPanel = document.getElementById('trainingLogs');
            if (data.logs && data.logs.length > 0) {
                data.logs.forEach(line => {
                    const div = document.createElement('div');
                    div.innerText = line;
                    logPanel.appendChild(div);
                });
                logPanel.scrollTop = logPanel.scrollHeight;
            }

            if (data.status.current_job) {
                document.getElementById('jobName').innerText = data.status.current_job.name;
            }

            if (!isTraining) {
                clearInterval(logInterval);
                document.getElementById('activeJobPanel').style.display = 'none';
                loadData();
                if (data.status.current_job && data.status.current_job.status === 'completed') {
                    alert("Training Completed Successfully!");
                }
            }
        } catch (e) { }
    }

    // ---- Policy Execution ----

    async function runPolicy(name) {
        if (!confirm(`Run policy '${name}' on Robot?`)) return;

        try {
            showPanel("policy", name); // Optimistic UI

            // 1. Load
            let res = await fetch('/api/policies/load', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ policy_name: name, device: 'auto' })
            });
            let data = await res.json();
            if (data.status !== 'ok') {
                alert("Load Failed: " + data.error);
                hidePanel();
                return;
            }

            // 2. Run
            res = await fetch('/api/policies/run', { method: 'POST' });
            data = await res.json();
            if (data.status === 'ok') {
                startPolicyMonitoring(name);
            } else {
                alert("Run Failed: " + data.error);
                hidePanel();
            }
        } catch (e) {
            console.error(e);
            alert("Error starting policy");
            hidePanel();
        }
    }

    function startPolicyMonitoring(name) {
        if (policyInterval) clearInterval(policyInterval);
        policyInterval = setInterval(pollPolicyStatus, 1000);
        showPanel("policy", name);
    }

    async function pollPolicyStatus() {
        try {
            const res = await fetch('/api/policies/status');
            const data = await res.json();

            if (!data.is_running) {
                clearInterval(policyInterval);
                hidePanel();
                // Check if it just stopped?
            } else {
                // Ensure panel is correct (in case refresh)
                showPanel("policy", data.current_policy);
            }
        } catch (e) { }
    }

    async function stopPolicy() {
        await fetch('/api/policies/stop', { method: 'POST' });
        hidePanel();
    }

    // ---- Shared UI ----

    function showPanel(type, name = "") {
        const panel = document.getElementById('activeJobPanel');
        panel.style.display = 'block';

        const title = panel.querySelector('h3');
        const btn = panel.querySelector('button');
        const list = panel.querySelector('#trainingLogs');

        if (type === 'training') {
            title.innerHTML = `üèÉ Active Training Job: <span id="jobName" style="color: #00d2ff;">${name || '...'}</span>`;
            btn.innerText = "Stop Training";
            btn.onclick = stopTraining;
            btn.className = "btn btn-danger";
            list.style.display = 'block';
        } else {
            title.innerHTML = `ü§ñ Running Policy: <span style="color: #0f0;">${name}</span>`;
            btn.innerText = "Stop Policy";
            btn.onclick = stopPolicy;
            btn.className = "btn btn-danger";
            list.style.display = 'none'; // No logs for inference
        }
    }

    function hidePanel() {
        document.getElementById('activeJobPanel').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        pollWorkers();

        // Restore state if page refresh
        fetch('/api/training/status').then(r => r.json()).then(d => {
            if (d.status.is_training) startMonitoring();
        });

        fetch('/api/policies/status').then(r => r.json()).then(d => {
            if (d.is_running) startPolicyMonitoring(d.current_policy);
        });
    });

    // ---- Auth ----

    async function checkAuthStatus() {
        try {
            const res = await fetch('/api/training/auth');
            const data = await res.json();
            const panel = document.getElementById('hfAuthPanel');

            if (data.username) {
                panel.innerHTML = `
                    <div style="margin-bottom:5px; color:#aaa;">Logged in as: <strong style="color:#0f0;">${data.username}</strong></div>
                    <button class="btn btn-sm btn-danger" onclick="hfLogout()">Logout</button>
                `;
            } else {
                panel.innerHTML = `
                    <div style="margin-bottom:5px; font-size:0.9em; color:#aaa;">Enter HF Write Token:</div>
                    <input type="password" id="hfToken" placeholder="hf_..." style="width:100%; margin-bottom:5px;">
                    <button class="btn btn-sm btn-primary" onclick="hfLogin()" style="width:100%;">Login to HuggingFace</button>
                `;
            }
        } catch (e) {
            console.error("Auth check failed", e);
            document.getElementById('hfAuthPanel').innerHTML = "Auth check failed.";
        }
    }

    async function hfLogin() {
        const token = document.getElementById('hfToken').value.trim();
        if (!token) return alert("Please enter a token");
        document.getElementById('hfAuthPanel').innerHTML = "Logging in...";
        try {
            const res = await fetch('/api/training/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: token })
            });
            const data = await res.json();
            if (data.status === 'ok') {
                alert(data.message);
                checkAuthStatus();
            } else {
                alert("Login Failed: " + data.message);
                checkAuthStatus();
            }
        } catch (e) { alert("Error: " + e); checkAuthStatus(); }
    }

    async function hfLogout() {
        if (!confirm("Logout from HuggingFace?")) return;
        await fetch('/api/training/auth/logout', { method: 'POST' });
        checkAuthStatus();
    }
</script>
{% endblock %}
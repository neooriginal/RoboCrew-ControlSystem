{% extends "base.html" %}

{% block title %}Training Dashboard{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/training.css') }}">
{% endblock %}

{% block content %}
<div class="train-container">

    <!-- Tab Navigation -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('train')" id="tab-train"><span>üöÄ</span> Create
            Policy</button>
        <button class="tab-btn" onclick="switchTab('monitor')" id="tab-monitor"><span>üìä</span> Monitor</button>
        <button class="tab-btn" onclick="switchTab('run')" id="tab-run"><span>ü§ñ</span> Run Policies</button>
    </div>

    <!-- TRAIN TAB (WIZARD) -->
    <div id="content-train" class="tab-content active">

        <!-- Steps Indicator -->
        <div class="wizard-progress">
            <div class="step-dot active" id="dot-1">1 <span class="step-label">Dataset</span></div>
            <div class="step-dot" id="dot-2">2 <span class="step-label">Config</span></div>
            <div class="step-dot" id="dot-3">3 <span class="step-label">Compute</span></div>
            <div class="step-dot" id="dot-4">4 <span class="step-label">Finish</span></div>
        </div>

        <!-- Step 1: Dataset Selection -->
        <div id="step-1" class="wizard-step">
            <h3 style="margin-bottom:20px;">Select Source Dataset</h3>
            <div id="dataset-list" class="card-grid">
                <div style="padding:20px; color:#666;">Loading datasets...</div>
            </div>
        </div>

        <!-- Step 2: Configuration -->
        <div id="step-2" class="wizard-step" style="display:none;">
            <h3 style="margin-bottom:20px;">Policy Configuration</h3>

            <div class="form-group">
                <label>Job Name</label>
                <input type="text" id="jobName" placeholder="e.g. pick_place_v1">
                <div style="font-size:0.8em; color:#666; margin-top:5px;">Unique identifier for this policy run.</div>
            </div>

            <div class="form-group">
                <label>Training Steps</label>
                <input type="number" id="trainSteps" value="2000" min="500" max="100000" step="500">
                <div style="font-size:0.8em; color:#666; margin-top:5px;">Steps. 2000 for tests, 20k+ for production.
                </div>
            </div>
        </div>

        <!-- Step 3: Compute -->
        <div id="step-3" class="wizard-step" style="display:none;">
            <h3 style="margin-bottom:20px;">Select Compute Backend</h3>

            <div class="card-grid">
                <!-- Remote User is Encouraged to Use -->
                <div class="selection-card" onclick="selectCompute('remote', this)" id="compute-remote">
                    <div class="card-icon">‚òÅÔ∏è</div>
                    <div class="card-title">Remote Worker</div>
                    <div class="card-meta">Offload to a powerful GPU workstation.</div>
                    <div id="worker-status" style="margin-top:10px; font-size:0.8em; color:#888;">Checking workers...
                    </div>
                </div>
            </div>

            <!-- Worker Downloads -->
            <div style="margin-top:20px; border-top:1px solid #333; padding-top:20px;">
                <h4 style="color:#aaa; margin-bottom:10px; font-size:0.9em;">Connect New Worker</h4>
                <div style="display:flex; gap:10px;">
                    <a href="/static/train_remote.bat" download class="btn"
                        style="background:#333; color:#fff; border:1px solid #555; font-size:0.9em; padding:8px 12px; text-decoration:none;">üì•
                        Windows Script</a>
                    <a href="/static/train_remote.sh" download class="btn"
                        style="background:#333; color:#fff; border:1px solid #555; font-size:0.9em; padding:8px 12px; text-decoration:none;">üì•
                        Linux/Mac Script</a>
                </div>
            </div>

            <!-- Advanced / Local Hidden -->
            <div style="margin-top:25px;">
                <a href="#"
                    onclick="document.getElementById('local-option').style.display='block'; this.style.display='none'; return false;"
                    style="color:#555; font-size:0.85em; text-decoration:underline;">Show Advanced Options (Local
                    Training)</a>

                <div id="local-option" style="display:none; margin-top:15px;" class="card-grid">
                    <div class="selection-card" onclick="selectCompute('local', this)" id="compute-local">
                        <div class="card-icon">üñ•Ô∏è</div>
                        <div class="card-title">Local Machine</div>
                        <div class="card-meta">Train on this device.</div>
                        <div style="margin-top:5px; font-size:0.8em; color:#ffaa00;">‚ö†Ô∏è Not Recommended (Slow/Laggy)
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Review -->
        <div id="step-4" class="wizard-step" style="display:none;">
            <h3 style="margin-bottom:20px;">Ready to Train?</h3>

            <div style="background:#1e1e1e; padding:20px; border-radius:8px; margin-bottom:20px;">
                <div style="margin-bottom:10px;"><strong>Dataset:</strong> <span id="review-dataset"
                        style="color:var(--primary);">...</span></div>
                <div style="margin-bottom:10px;"><strong>Job Name:</strong> <span id="review-job">...</span></div>
                <div style="margin-bottom:10px;"><strong>Steps:</strong> <span id="review-steps">...</span></div>
                <div><strong>Compute:</strong> <span id="review-compute">...</span></div>
            </div>
        </div>

        <!-- Footer Navigation -->
        <div class="wizard-footer">
            <button class="btn" id="btn-back" onclick="moveStep(-1)"
                style="display:none; background:#333; color:#fff;">Back</button>
            <div style="flex:1;"></div>
            <button class="btn btn-primary" id="btn-next" onclick="moveStep(1)">Next Step ‚Üí</button>
            <button class="btn btn-success" id="btn-start" onclick="startTraining()" style="display:none;">üöÄ Start
                Training</button>
        </div>
    </div>

    <!-- MONITOR TAB -->
    <div id="content-monitor" class="tab-content">
        <div class="monitor-panel">
            <div class="monitor-header">
                <div>
                    <h2 id="monitor-title" style="margin:0; font-size:1.2rem;">No Active Job</h2>
                    <span id="monitor-status" style="color:#666; font-size:0.9em;">Idle</span>
                </div>
                <button class="btn btn-danger" id="btn-stop" onclick="stopTraining()"
                    style="display:none;">Stop</button>
            </div>

            <div id="monitor-active-view" style="display:none; flex-direction:column; flex:1;">
                <div class="progress-section">
                    <div style="font-size:2rem; font-weight:bold; color:var(--primary);" id="progress-pct">0%</div>
                    <div style="color:#888; font-size:0.9em;" id="progress-details">Initializing...</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                </div>
                <div class="logs-container" id="training-logs">
                    <div class="log-line info">Waiting for logs...</div>
                </div>
            </div>

            <div id="monitor-empty-view" class="empty-state" style="margin:50px;">
                <div style="font-size:3rem; margin-bottom:20px;">üí§</div>
                <h3>No training in progress</h3>
                <p>Start a new policy training in the "Create Policy" tab.</p>
            </div>
        </div>
    </div>

    <!-- RUN TAB -->
    <div id="content-run" class="tab-content">
        <div style="margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
            <h3>Available Policies</h3>
            <button class="btn" onclick="loadPolicies()"
                style="background:#333; color:#fff; font-size:0.9em; padding:8px 12px;">üîÑ Refresh</button>
        </div>

        <div id="policy-list-container">
            <div class="empty-state">Loading...</div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    // ---- State ----
    let currentStep = 1;
    let wizardData = {
        dataset: null,
        jobName: '',
        steps: 2000,
        compute: null // Force selection
    };
    let isTraining = false;
    let logInterval = null;
    let logIndex = 0;
    let workerCount = 0;

    // ---- Init ----
    document.addEventListener('DOMContentLoaded', () => {
        loadDatasets();
        pollWorkers();
        checkActiveTraining();
        checkAuthRequirement();
        setInterval(pollWorkers, 5000);
    });

    async function checkAuthRequirement() {
        try {
            const res = await fetch('/api/auth/hf/status');
            const data = await res.json();
            if (!data.logged_in) {
                // Block wizard
                const wizard = document.getElementById('step-1');
                if (wizard) {
                    const overlay = document.createElement('div');
                    overlay.style.position = 'absolute';
                    overlay.style.top = '0';
                    overlay.style.left = '0';
                    overlay.style.right = '0';
                    overlay.style.bottom = '0';
                    overlay.style.background = 'rgba(0,0,0,0.8)';
                    overlay.style.zIndex = '1000';
                    overlay.style.display = 'flex';
                    overlay.style.flexDirection = 'column';
                    overlay.style.alignItems = 'center';
                    overlay.style.justifyContent = 'center';
                    overlay.innerHTML = `
                        <h2>‚ö†Ô∏è Hugging Face Login Required</h2>
                        <p style="color:#aaa; margin-bottom:20px;">You must be logged in to train policies.</p>
                        <a href="/settings" class="btn btn-primary">Go to Settings</a>
                     `;
                    wizard.style.position = 'relative'; // Ensure positioning context
                    wizard.appendChild(overlay);
                }
                // Disable Next button too just in case
                document.getElementById('btn-next').disabled = true;
            }
        } catch (e) { }
    }

    // ---- Wizard Logic ----

    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        document.getElementById(`tab-${tab}`).classList.add('active');
        document.getElementById(`content-${tab}`).classList.add('active');

        if (tab === 'run') loadPolicies();
    }

    function moveStep(delta) {
        // Validation
        if (delta > 0) {
            if (currentStep === 1 && !wizardData.dataset) return alert("Please select a dataset.");
            if (currentStep === 2) {
                const name = document.getElementById('jobName').value.trim();
                if (!name) return alert("Please enter a Job Name.");
                wizardData.jobName = name;
                wizardData.steps = document.getElementById('trainSteps').value;
            }
            if (currentStep === 3) {
                if (!wizardData.compute) return alert("Please select a compute backend (Local or Remote).");
                if (wizardData.compute === 'remote' && workerCount === 0) {
                    return alert("No workers connected. Please connect a worker or use Local (Advanced).");
                }
            }
        }

        currentStep += delta;

        // Update UI
        document.querySelectorAll('.wizard-step').forEach(el => el.style.display = 'none');
        document.getElementById(`step-${currentStep}`).style.display = 'block';

        // Update Dots
        for (let i = 1; i <= 4; i++) {
            const dot = document.getElementById(`dot-${i}`);
            dot.classList.remove('active', 'completed');
            if (i === currentStep) dot.classList.add('active');
            if (i < currentStep) dot.classList.add('completed');
        }

        // Show/Hide Buttons
        document.getElementById('btn-back').style.display = currentStep > 1 ? 'block' : 'none';

        if (currentStep === 4) {
            document.getElementById('btn-next').style.display = 'none';
            document.getElementById('btn-start').style.display = 'block';
            updateReview();
        } else {
            document.getElementById('btn-next').style.display = 'block';
            document.getElementById('btn-start').style.display = 'none';
        }
    }

    function selectDataset(name, el) {
        wizardData.dataset = name;
        document.querySelectorAll('#dataset-list .selection-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');

        // Auto-fill Job Name if empty
        const jobInput = document.getElementById('jobName');
        if (!jobInput.value) {
            const date = new Date();
            const ts = `${date.getMonth() + 1}${date.getDate()}_${date.getHours()}${date.getMinutes()}`;
            jobInput.value = `policy_${name}_${ts}`;
        }
    }

    function selectCompute(type, el) {
        if (type === 'remote' && workerCount === 0) {
            alert("No workers connected. Please connect a worker script first.");
            return;
        }
        wizardData.compute = type;
        document.querySelectorAll('#step-3 .selection-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
    }

    function updateReview() {
        document.getElementById('review-dataset').innerText = wizardData.dataset;
        document.getElementById('review-job').innerText = wizardData.jobName;
        document.getElementById('review-steps').innerText = wizardData.steps;
        document.getElementById('review-compute').innerText = wizardData.compute === 'local' ? 'Local Machine' : 'Remote Worker';
    }

    // ---- CRUD Actions ----

    async function renameDataset(oldName) {
        const newName = prompt("Enter new name for dataset '" + oldName + "':", oldName);
        if (!newName || newName === oldName) return;

        try {
            const res = await fetch('/api/training/datasets/rename', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ old_name: oldName, new_name: newName })
            });
            const data = await res.json();
            if (data.status === 'ok') {
                loadDatasets();
            } else {
                alert("Error: " + data.message);
            }
        } catch (e) { alert("Req error: " + e); }
    }

    async function deleteDataset(name) {
        if (!confirm(`‚ö†Ô∏è PERMANENTLY DELETE '${name}'?`)) return;

        try {
            const res = await fetch('/api/training/datasets/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dataset_name: name })
            });
            const data = await res.json();
            if (data.status === 'ok') {
                loadDatasets();
            } else {
                alert("Error: " + data.message);
            }
        } catch (e) { alert("Req error: " + e); }
    }

    // ---- Data Loading ----

    async function loadDatasets() {
        try {
            const res = await fetch('/api/training/datasets');
            const data = await res.json();
            const container = document.getElementById('dataset-list');

            if (data.datasets.length === 0) {
                container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;">No datasets found.<br><small>Record a new dataset in Remote Control -> Record</small></div>';
                return;
            }

            container.innerHTML = data.datasets.map(name => `
                <div class="selection-card" style="display:flex; flex-direction:column;">
                    <div style="flex:1; cursor:pointer;" onclick="selectDataset('${name}', this.parentElement)">
                        <div class="card-icon">üíæ</div>
                        <div class="card-title">${name}</div>
                        <div class="card-meta">Local Dataset</div>
                    </div>
                    <div style="border-top:1px solid #333; padding-top:10px; margin-top:10px; display:flex; justify-content:space-between; gap:5px;">
                         <button class="btn btn-sm" onclick="event.stopPropagation(); renameDataset('${name}')" style="background:#333; color:#fff; font-size:0.85em; padding:6px 10px; border:1px solid #555;">Rename</button>
                         <button class="btn btn-sm" onclick="event.stopPropagation(); deleteDataset('${name}')" style="background:rgba(255,50,50,0.2); color:#ff5555; font-size:0.85em; padding:6px 10px; border:1px solid rgba(255,50,50,0.3);">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        } catch (e) { console.error(e); }
    }


    async function loadPolicies() {
        try {
            const res = await fetch('/api/training/policies');
            const data = await res.json();
            const container = document.getElementById('policy-list-container');

            if (data.policies.length === 0) {
                container.innerHTML = '<div class="empty-state">No trained policies found. Start training!</div>';
                return;
            }

            container.innerHTML = data.policies.map(p => {
                const escapedName = p.name.replace(/'/g, "\\'");
                const escapedDesc = (p.description || '').replace(/"/g, '&quot;');
                const displayName = p.name.includes('/') ? p.name.split('/').pop() : p.name;

                return `
                <div class="policy-item" style="${p.enabled ? '' : 'opacity:0.6; border:1px solid #444;'}">
                    <div class="policy-info" style="width:100%;">
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            <div class="policy-name" title="${p.name}">${displayName}</div>
                            <label style="font-size:0.85em; cursor:pointer;">
                                <input type="checkbox" ${p.enabled ? 'checked' : ''} 
                                    onchange="updatePolicy('${escapedName}', 'enabled', this.checked)"> Enabled
                            </label>
                        </div>
                        
                        <div style="margin-top:5px;">
                            <input type="text" value="${escapedDesc}" placeholder="Add description for AI..." 
                                onblur="updatePolicy('${escapedName}', 'description', this.value)"
                                style="background:rgba(0,0,0,0.2); border:1px solid #444; color:#ddd; padding:4px 8px; width:100%; border-radius:4px; font-size:0.9em;">
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; align-items:center; margin-left:15px;">
                        <button class="btn btn-sm btn-success" onclick="runPolicy('${escapedName}')" ${p.enabled ? '' : 'disabled'}>‚ñ∂ Run</button>
                    </div>
                </div>
            `}).join('');
        } catch (e) { console.error(e); }
    }


    async function updatePolicy(name, field, value) {
        try {
            const payload = { name: name };
            payload[field] = value;

            const res = await fetch('/api/policies/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data.status !== 'ok') {
                console.error("Update failed:", data.error);
                // alert("Update failed: " + data.error);
            } else {
                if (field === 'enabled') loadPolicies(); // Refresh to update visual state/button
            }
        } catch (e) { console.error(e); }
    }

    async function pollWorkers() {
        try {
            const res = await fetch('/api/training/worker_status');
            const data = await res.json();
            workerCount = data.workers ? data.workers.length : 0;
            const statusEl = document.getElementById('worker-status');
            const remoteCard = document.getElementById('compute-remote');

            if (workerCount > 0) {
                statusEl.innerHTML = `<span style="color:#00ff9d;">‚óè ${workerCount} Worker(s) online</span>`;
                if (remoteCard) remoteCard.style.opacity = '1';
            } else {
                statusEl.innerHTML = `<span style="color:#888;">‚óè No workers connected</span>`;
                if (remoteCard) {
                    if (wizardData.compute === 'remote') {
                        // Don't auto-deselect just yet to avoid jumping, but user can't click next
                    }
                    remoteCard.style.opacity = '0.4';
                }
            }
        } catch (e) { }
    }

    // ---- Training Actions ----

    async function startTraining() {
        const payload = {
            dataset: wizardData.dataset,
            job_name: wizardData.jobName,
            device: wizardData.compute === 'local' ? 'auto' : 'remote',
            steps: parseInt(wizardData.steps)
        };

        try {
            const res = await fetch('/api/training/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if (data.status === 'ok') {
                switchTab('monitor');
                setTimeout(() => {
                    currentStep = 1;
                    moveStep(0);
                }, 1000);
                startMonitoring(true);
            } else {
                alert("Error: " + data.error);
            }
        } catch (e) { alert("Request Error: " + e); }
    }

    async function stopTraining() {
        if (!confirm("Stop current training job?")) return;
        try {
            await fetch('/api/training/stop', { method: 'POST' });
            setTimeout(() => startMonitoring(), 1000);
        } catch (e) { alert("Stop failed: " + e); }
    }

    // ---- Monitoring Logic ----

    function checkActiveTraining() {
        fetch('/api/training/status').then(r => r.json()).then(d => {
            if (d.status.is_training) {
                switchTab('monitor');
                startMonitoring();
            }
        });
    }

    function startMonitoring(reset = false) {
        if (logInterval) clearInterval(logInterval);

        document.getElementById('monitor-empty-view').style.display = 'none';
        document.getElementById('monitor-active-view').style.display = 'flex';
        document.getElementById('btn-stop').style.display = 'block';

        if (reset) {
            document.getElementById('training-logs').innerHTML = '';
            logIndex = 0;
        }

        logInterval = setInterval(pollStatus, 1000);
    }

    async function pollStatus() {
        try {
            const res = await fetch(`/api/training/status?since=${logIndex}`);
            const data = await res.json();

            const job = data.status.current_job;
            if (job) {
                document.getElementById('monitor-title').innerText = job.name;

                if (job.status === 'pending') {
                    document.getElementById('monitor-status').innerHTML = '<span style="color:#ffaa00">Waiting for Worker...</span>';
                    document.getElementById('progress-details').innerText = "Queued in Cloud...";
                } else {
                    document.getElementById('monitor-status').innerText = data.status.is_training ? "Running..." : job.status;
                }
            }

            if (data.logs && data.logs.length > 0) {
                logIndex += data.logs.length;
                const container = document.getElementById('training-logs');

                data.logs.forEach(line => {
                    const div = document.createElement('div');
                    div.className = 'log-line';
                    div.innerText = line;
                    container.appendChild(div);

                    const stepsMatch = line.match(/'step':\s*(\d+)/);
                    if (stepsMatch) {
                        const current = parseInt(stepsMatch[1]);
                        if (!window.maxSteps) {
                            const maxMatch = line.match(/cfg\.steps=(\d+)/);
                            if (maxMatch) window.maxSteps = parseInt(maxMatch[1]);
                        }
                        const max = window.maxSteps || wizardData.steps || 2000;

                        const pct = Math.min(100, (current / max) * 100).toFixed(1);
                        document.getElementById('progress-bar').style.width = pct + '%';
                        document.getElementById('progress-pct').innerText = pct + '%';
                        document.getElementById('progress-details').innerText = `Step ${current} / ${max}`;
                    }
                });
                container.scrollTop = container.scrollHeight;
            }

            if (!data.status.is_training) {
                clearInterval(logInterval);
                document.getElementById('monitor-status').innerText = job ? job.status : "Stopped";
                document.getElementById('btn-stop').style.display = 'none';
                if (job && job.status === 'completed') {
                    document.getElementById('progress-pct').innerText = "100%";
                    document.getElementById('progress-bar').style.width = "100%";
                    document.getElementById('progress-details').innerText = "Training Complete";
                }
            }
        } catch (e) { }
    }

    // ---- Policy Running ----
    async function runPolicy(name) {
        if (!confirm(`Run policy '${name}'? Robot will start moving!`)) return;

        fetch('/api/policies/load', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ policy_name: name })
        }).then(r => r.json()).then(d => {
            if (d.status === 'ok') {
                return fetch('/api/policies/run', { method: 'POST' });
            } else throw d.error;
        }).then(r => r.json()).then(d => {
            if (d.status === 'ok') alert("Policy Running! Check Dashboard/Display.");
            else alert("Error: " + d.error);
        }).catch(e => alert("Error: " + e));
    }

</script>
{% endblock %}
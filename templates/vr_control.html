{% extends "base.html" %}

{% block title %}VR Control{% endblock %}

{% block head %}
<script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<!-- We keep specific VR styles but override body background handled by base -->
<link rel="stylesheet" href="/static/css/vr_styles.css">
{% endblock %}

{% block content %}
<div style="position: relative; height: 100%; border-radius: 12px; overflow: hidden; background: #000;">

    <!-- Status Overlay adapted for Dashboard -->
    <div id="statusPanel" class="status-panel"
        style="position: absolute; top: 20px; left: 280px; z-index: 1000; background: rgba(0,0,0,0.8); border: 1px solid var(--border-color); padding: 20px; border-radius: 12px;">
        <h2 style="margin: 0 0 15px 0; color: var(--primary);">ðŸ¤– RoboCrew VR</h2>
        <div class="status-grid" style="display: grid; gap: 10px; margin-bottom: 20px;">
            <div class="status-item" style="display: flex; align-items: center; gap: 10px;">
                <div class="status-indicator" id="wsStatus"
                    style="width: 10px; height: 10px; border-radius: 50%; background: #555;"></div>
                <span style="color: var(--text-secondary);">Connection</span>
            </div>
            <div class="status-item" style="display: flex; align-items: center; gap: 10px;">
                <div class="status-indicator" id="armStatus"
                    style="width: 10px; height: 10px; border-radius: 50%; background: #555;"></div>
                <span style="color: var(--text-secondary);">Arm Control</span>
            </div>
        </div>
        <div class="instructions">
            <h3 style="color: #fff; font-size: 0.9rem; margin-bottom: 10px;">ðŸŽ® Controls</h3>
            <div style="color: #aaa; font-size: 0.8rem; line-height: 1.5;">
                <div><strong>Grip:</strong> Hold to move arm</div>
                <div><strong>Trigger:</strong> Close gripper</div>
                <div><strong>Thumbstick:</strong> Move robot</div>
            </div>
        </div>
    </div>

    <!-- The Scene -->
    <a-scene vr-controller-updater vr-mode-ui="enabled: false;" embedded style="width: 100%; height: 100%;">
        <a-entity webxr-passthrough="referenceSpaceType: local-floor"></a-entity>

        <a-entity id="cameraPanel" position="0 1.2 -1.5">
            <!-- Tilted slightly up for better viewing from seated/standing -->
            <a-entity rotation="-15 0 0">
                <a-plane id="cameraPlane" width="1.6" height="0.9"
                    material="shader: flat; src: #cameraTexture; transparent: true; opacity: 0.95"></a-plane>
                <a-text value="Camera" position="0 0.5 0" align="center" scale="0.1 0.1 0.1" color="#00d2ff"></a-text>
            </a-entity>

        </a-entity>

        <a-entity id="rightHand" oculus-touch-controls="hand: right">
            <a-text id="rightHandInfo" value="Ready" position="0 0.04 -0.05" scale="0.05 0.05 0.05" color="white"
                align="center"></a-text>

            <!-- Gripper Visual Overlay -->
            <a-entity id="gripperVisual" position="0 0 0" rotation="0 0 0">
                <!-- Wrist base -->
                <a-box width="0.04" height="0.04" depth="0.06" color="#333" position="0 0 -0.05"></a-box>
                <!-- Left finger -->
                <a-box id="fingerL" width="0.005" height="0.03" depth="0.06" color="#666"
                    position="-0.015 0 -0.11"></a-box>
                <!-- Right finger -->
                <a-box id="fingerR" width="0.005" height="0.03" depth="0.06" color="#666"
                    position="0.015 0 -0.11"></a-box>
            </a-entity>

            <a-cylinder height="0.08" radius="0.003" color="#ff0000" position="0.04 0 0" rotation="0 0 90"></a-cylinder>
            <a-cylinder height="0.08" radius="0.003" color="#00ff00" position="0 0.04 0"></a-cylinder>
            <a-cylinder height="0.08" radius="0.003" color="#0000ff" position="0 0 0.04" rotation="90 0 0"></a-cylinder>
        </a-entity>

        <a-entity id="leftHand" oculus-touch-controls="hand: left">
            <a-text id="leftHandInfo" value="Move" position="0 0.04 -0.05" scale="0.05 0.05 0.05" color="white"
                align="center"></a-text>
        </a-entity>

        <a-assets>
            <img id="cameraTexture" crossorigin="anonymous">
        </a-assets>
    </a-scene>

</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const cameraImg = document.getElementById('cameraTexture');
        const cameraPlane = document.getElementById('cameraPlane');
        // We use /video_feed on the dashboard generally, but VR needs it as a texture
        // The texture loader in A-Frame handles it.
        cameraImg.src = '/video_feed';

        setInterval(() => {
            if (cameraPlane && cameraPlane.getObject3D('mesh')) {
                const mat = cameraPlane.getObject3D('mesh').material;
                if (mat.map) mat.map.needsUpdate = true;
            }
        }, 100);
    });
</script>

<script src="/static/js/vr_app.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Since we embedded the scene, we might need to adjust some startup logic
        const scene = document.querySelector('a-scene');

        // Re-style the user provided VR button (created by our script) if needed,
        // or just use our own button.
        // The original logic created a button on the body. We should probably create it inside the block.

        if (!navigator.xr) return;

        Promise.all([
            navigator.xr.isSessionSupported('immersive-ar').catch(() => false),
            navigator.xr.isSessionSupported('immersive-vr').catch(() => false)
        ]).then(([ar, vr]) => {
            if (!ar && !vr) return;

            const btn = document.createElement('button');
            btn.className = 'btn btn-primary';
            btn.style.position = 'absolute';
            btn.style.bottom = '30px';
            btn.style.left = '50%';
            btn.style.transform = 'translateX(-50%)';
            btn.style.zIndex = '2000';
            btn.style.fontSize = '1.2rem';
            btn.style.padding = '15px 30px';

            btn.textContent = 'ðŸ¥½ Enter VR';
            btn.onclick = async () => {
                btn.textContent = 'Starting...';
                btn.disabled = true;
                try {
                    await document.querySelector('a-scene').enterVR(true);
                } catch (e) {
                    btn.textContent = 'ðŸ¥½ Enter VR';
                    btn.disabled = false;
                    alert('VR Entry Failed: ' + e);
                }
            };

            // Append to the content wrapper relative container for better positioning
            document.querySelector('.content-wrapper > div').appendChild(btn);

            scene.addEventListener('enter-vr', () => {
                btn.style.display = 'none';
                document.getElementById('statusPanel').style.display = 'none';
                // Hide dashboard sidebar/header via CSS if needed, but A-Frame fullscreen usually handles it.
            });
            scene.addEventListener('exit-vr', () => {
                btn.style.display = 'block';
                document.getElementById('statusPanel').style.display = 'block';
            });
        });
    });
</script>
{% endblock %}
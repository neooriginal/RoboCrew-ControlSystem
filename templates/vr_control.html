{% extends "base.html" %}

{% block title %}VR Control{% endblock %}

{% block head %}
<script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/vr_styles.css') }}">
{% endblock %}

{% block content %}
<div style="position: relative; height: 100%; border-radius: 12px; overflow: hidden; background: #000;"
    class="vr-restricted">

    <div class="vr-only-overlay">
        <div class="mobile-restricted-icon">ü•Ω</div>
        <div class="vr-restricted-title">VR Mode</div>
        <p class="vr-restricted-msg">
            This mode is designed for <strong>Standalone VR Headsets</strong> (e.g., Meta Quest) via the onboard
            browser, or Desktop WebXR.
            <br><br>
            <span style="font-size: 0.8em; opacity: 0.7;">Mobile phone control is not currently supported.</span>
        </p>
    </div>

    <div id="statusPanel" class="status-panel"
        style="position: absolute; top: 20px; left: 280px; z-index: 1000; background: rgba(0,0,0,0.8); border: 1px solid var(--border-color); padding: 20px; border-radius: 12px;">
        <h2 style="margin: 0 0 5px 0; color: var(--primary);">ü§ñ ARCS VR</h2>
        <div style="font-size: 0.75rem; color: var(--warning); margin-bottom: 15px; letter-spacing: 0.5px;">
            <span style="font-size: 1.2em; vertical-align: middle;">‚ö†Ô∏è</span> USE STANDALONE VR BROWSER
        </div>
        <div class="status-grid" style="display: grid; gap: 10px; margin-bottom: 20px;">
            <div class="status-item" style="display: flex; align-items: center; gap: 10px;">
                <div class="status-indicator" id="wsStatus"
                    style="width: 10px; height: 10px; border-radius: 50%; background: #555;"></div>
                <span style="color: var(--text-secondary);">Connection</span>
            </div>
            <div class="status-item" style="display: flex; align-items: center; gap: 10px;">
                <div class="status-indicator" id="armStatus"
                    style="width: 10px; height: 10px; border-radius: 50%; background: #555;"></div>
                <span style="color: var(--text-secondary);">Arm Control</span>
            </div>

            <!-- Recording Controls -->
            <div class="recording-controls" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
                <input type="text" id="datasetName" placeholder="Dataset Name"
                    style="background: #222; border: 1px solid #444; color: #fff; padding: 5px; border-radius: 4px; width: 100%; margin-bottom: 8px;">

                <div
                    style="font-size: 0.8em; color: #aaa; text-align: center; border: 1px solid #444; padding: 8px; border-radius: 4px; background: #222;">
                    Press <strong>(A)</strong> to Record
                </div>

                <!-- Hidden button for logic compatibility or unforeseen debug needs -->
                <button id="recordBtn" style="display: none;"></button>

                <div id="recordingStatus"
                    style="font-size: 0.7em; color: #ff4444; margin-top: 5px; display: none; text-align: center; font-weight: bold;">
                    ‚óè Recording: <span id="recFrameCount">0</span> frames
                </div>
            </div>
        </div>
        <div class="instructions">
            <h3 style="color: #fff; font-size: 0.9rem; margin-bottom: 10px;">üéÆ Controls</h3>
            <div style="color: #aaa; font-size: 0.8rem; line-height: 1.5;">
                <div><strong>Grip:</strong> Hold to move arm</div>
                <div><strong>Trigger:</strong> Close gripper</div>
                <div><strong>Button A:</strong> Record/Stop</div>
                <div><strong>Thumbstick:</strong> Move robot</div>
            </div>
        </div>
    </div>

    <!-- The Scene -->
    <a-scene vr-controller-updater vr-mode-ui="enabled: false;" embedded style="width: 100%; height: 100%;">
        <a-entity webxr-passthrough="referenceSpaceType: local-floor"></a-entity>

        <a-entity id="cameraPanel" position="0 1.2 -1.5">
            <a-entity rotation="-15 0 0">
                <a-plane id="cameraPlane" width="1.6" height="0.9"
                    material="shader: flat; src: #cameraTexture; transparent: true; opacity: 0.95"></a-plane>

                <!-- Right Camera Feed -->
                <a-plane id="cameraPlaneRight" width="0.53" height="0.3" position="1.1 -0.3 0.1" rotation="0 -15 0"
                    material="shader: flat; src: #cameraTextureRight; transparent: true; opacity: 0.95; side: double"></a-plane>

                <a-text value="Powered by ARCS" position="0 0.5 0" align="center" scale="0.1 0.1 0.1"
                    color="#00d2ff"></a-text>

                <!-- VR Recording Indicator (Hidden by default) -->
                <a-entity id="vrRecIndicator" visible="false" position="0.7 0.4 0.02">
                    <a-circle color="#ff0000" radius="0.03"></a-circle>
                    <a-text value="REC" position="0.05 0 0" align="left" scale="0.2 0.2 0.2" color="#ff0000"></a-text>
                </a-entity>
            </a-entity>

        </a-entity>

        <a-entity id="rightHand" oculus-touch-controls="hand: right">
            <a-text id="rightHandInfo" value="Ready\nA: Record" position="0 0.04 -0.05" scale="0.05 0.05 0.05"
                color="white" align="center"></a-text>

            <a-entity id="gripperVisual" position="0 0 0" rotation="0 0 0">
                <a-box width="0.04" height="0.04" depth="0.06" color="#333" position="0 0 -0.05"></a-box>

                <a-box width="0.008" height="0.08" depth="0.02" color="#666" position="-0.02 0 -0.10"></a-box>

                <a-entity id="fingerMoving" position="0.02 0 -0.10">
                    <a-box width="0.008" height="0.08" depth="0.02" color="#666" position="0 0 0"></a-box>
                    <a-box width="0.02" height="0.008" depth="0.02" color="#666" position="-0.01 0.036 0"></a-box>
                </a-entity>
            </a-entity>

            <a-cylinder height="0.08" radius="0.003" color="#ff0000" position="0.04 0 0" rotation="0 0 90"></a-cylinder>
            <a-cylinder height="0.08" radius="0.003" color="#00ff00" position="0 0.04 0"></a-cylinder>
            <a-cylinder height="0.08" radius="0.003" color="#0000ff" position="0 0 0.04" rotation="90 0 0"></a-cylinder>
        </a-entity>

        <a-entity id="leftHand" oculus-touch-controls="hand: left">
            <a-text id="leftHandInfo" value="Move" position="0 0.04 -0.05" scale="0.05 0.05 0.05" color="white"
                align="center"></a-text>
        </a-entity>

        <a-assets>
            <img id="cameraTexture" crossorigin="anonymous">
            <img id="cameraTextureRight" crossorigin="anonymous">
        </a-assets>
    </a-scene>

</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/vr_control_handlers.js') }}"></script>
<script src="/static/js/vr_app.js"></script>
{% endblock %}
{% extends "base.html" %}

{% block title %}AI Agent{% endblock %}

{% block content %}
<div class="ai-layout">
    <div class="ai-video">
        <img src="/ai_video_feed" style="width: 100%; height: 100%; object-fit: contain;"
            alt="Robot View (CV Processed)">
        <div
            style="position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1);">
            <div class="status-indicator" style="padding: 0; background: none;">
                <div id="ai-status-dot" class="status-dot"></div>
                <span id="ai-status-text" class="status-text">Idle</span>
            </div>
        </div>
    </div>

    <div class="ai-controls">
        <div class="control-card" style="flex: 1; display: flex; flex-direction: column; gap: 15px;">
            <h3 style="color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase;">Task Control</h3>

            <textarea id="task-input" class="task-input" rows="3"
                style="width: 100%; padding: 10px; background: #000; border: 1px solid var(--border-color); color: #fff; border-radius: 6px; resize: none;"
                placeholder="Enter task... (e.g., 'go through the door')"></textarea>

            <button id="btn-set-task" class="btn"
                style="background: var(--bg-panel); border: 1px solid var(--border-color); color: var(--text-secondary);">Set
                Task</button>

            <div style="display: flex; gap: 10px; margin-top: auto;">
                <button id="btn-start" class="btn btn-primary" style="flex: 1; justify-content: center;">Start
                    AI</button>
                <button id="btn-stop" class="btn btn-danger" style="flex: 1; justify-content: center;">Pause AI</button>
            </div>

            <button id="btn-estop" class="btn btn-danger"
                style="width: 100%; justify-content: center; font-weight: bold; margin-top: 10px;">
                EMERGENCY STOP
            </button>
        </div>

        <div class="control-card">
            <div class="slam-header"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="color: var(--text-secondary); font-size: 0.9rem; margin: 0;">SLAM Map</h3>
                <div style="display: flex; gap: 5px;">
                    <button id="slam-toggle" class="btn"
                        style="padding: 2px 8px; font-size: 10px; background: var(--success); color: #000;">ON</button>
                    <button id="slam-reset" class="btn"
                        style="padding: 2px 8px; font-size: 10px; background: #333;">Reset</button>
                </div>
            </div>
            <canvas id="slam-canvas"
                style="width: 100%; height: 150px; background: #000; border: 1px solid var(--border-color); border-radius: 4px;"></canvas>
            <div class="slam-stats"
                style="display: flex; justify-content: space-between; font-size: 10px; color: var(--text-secondary); margin-top: 5px;">
                <span id="slam-frames">Frames: 0</span>
                <span id="slam-points">Points: 0</span>
                <span id="slam-loops">Loops: 0</span>
            </div>
        </div>

        <div class="control-card" style="flex: 1; display: flex; flex-direction: column;">
            <h3 style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 10px;">System Logs</h3>
            <div class="log-window" id="log-window" style="flex: 1; height: auto;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    var slamCanvas = document.getElementById('slam-canvas');
    var slamCtx = slamCanvas.getContext('2d');
    var slamEnabled = true;

    function resizeSlamCanvas() {
        var rect = slamCanvas.getBoundingClientRect();
        slamCanvas.width = rect.width * window.devicePixelRatio;
        slamCanvas.height = rect.height * window.devicePixelRatio;
        slamCtx.scale(window.devicePixelRatio, window.devicePixelRatio);
    }
    resizeSlamCanvas();
    window.addEventListener('resize', resizeSlamCanvas);

    function drawSlamMap(trajectory, pointCloud) {
        var w = slamCanvas.width / window.devicePixelRatio;
        var h = slamCanvas.height / window.devicePixelRatio;
        slamCtx.clearRect(0, 0, w, h);

        if (!trajectory || trajectory.length === 0) {
            slamCtx.fillStyle = '#333';
            slamCtx.font = '12px sans-serif';
            slamCtx.textAlign = 'center';
            slamCtx.fillText('No trajectory data', w / 2, h / 2);
            return;
        }

        var minX = Infinity, maxX = -Infinity;
        var minY = Infinity, maxY = -Infinity;
        for (var i = 0; i < trajectory.length; i++) {
            var x = trajectory[i][0];
            var y = trajectory[i][2];
            if (x < minX) minX = x;
            if (x > maxX) maxX = x;
            if (y < minY) minY = y;
            if (y > maxY) maxY = y;
        }

        var rangeX = maxX - minX || 1;
        var rangeY = maxY - minY || 1;
        var scale = Math.min((w - 40) / rangeX, (h - 40) / rangeY);
        var offsetX = (w - rangeX * scale) / 2;
        var offsetY = (h - rangeY * scale) / 2;

        function toScreen(pt) {
            return {
                x: offsetX + (pt[0] - minX) * scale,
                y: offsetY + (pt[2] - minY) * scale
            };
        }

        if (pointCloud && pointCloud.length > 0) {
            slamCtx.fillStyle = 'rgba(100, 100, 200, 0.3)';
            for (var j = 0; j < pointCloud.length; j++) {
                var p = toScreen(pointCloud[j]);
                slamCtx.fillRect(p.x - 1, p.y - 1, 2, 2);
            }
        }

        slamCtx.strokeStyle = '#0f0';
        slamCtx.lineWidth = 2;
        slamCtx.beginPath();
        var first = toScreen(trajectory[0]);
        slamCtx.moveTo(first.x, first.y);
        for (var k = 1; k < trajectory.length; k++) {
            var pt = toScreen(trajectory[k]);
            slamCtx.lineTo(pt.x, pt.y);
        }
        slamCtx.stroke();

        var last = toScreen(trajectory[trajectory.length - 1]);
        slamCtx.fillStyle = '#ff0';
        slamCtx.beginPath();
        slamCtx.arc(last.x, last.y, 4, 0, Math.PI * 2);
        slamCtx.fill();
    }

    function updateSlam() {
        if (!slamEnabled) return;
        fetch('/slam/data')
            .then(function (r) { return r.json(); })
            .then(function (data) {
                if (data.error) return;
                drawSlamMap(data.trajectory, data.point_cloud);
                document.getElementById('slam-frames').textContent = 'Frames: ' + data.frame_count;
                document.getElementById('slam-points').textContent = 'Points: ' + data.total_points;
                document.getElementById('slam-loops').textContent = 'Loops: ' + data.loop_closures;
            })
            .catch(function (e) { });
    }

    document.getElementById('slam-toggle').addEventListener('click', function () {
        fetch('/slam/toggle', { method: 'POST' })
            .then(function (r) { return r.json(); })
            .then(function (data) {
                slamEnabled = data.enabled;
                var btn = document.getElementById('slam-toggle');
                btn.textContent = slamEnabled ? 'ON' : 'OFF';
                btn.style.background = slamEnabled ? 'var(--success)' : '#333';
            });
    });

    document.getElementById('slam-reset').addEventListener('click', function () {
        fetch('/slam/reset', { method: 'POST' });
    });

    function updateStatus() {
        fetch('/ai/status')
            .then(function (r) { return r.json(); })
            .then(function (data) {
                var dot = document.getElementById('ai-status-dot');
                var text = document.getElementById('ai-status-text');
                var logs = document.getElementById('log-window');

                if (data.enabled) {
                    dot.className = 'status-dot active';
                    text.textContent = 'Running: ' + data.status;
                } else {
                    dot.className = 'status-dot';
                    text.textContent = 'Stopped: ' + data.status;
                }

                var html = '';
                for (var i = 0; i < data.logs.length; i++) {
                    html += '<div class="log-entry">' + data.logs[i] + '</div>';
                }
                logs.innerHTML = html;
                logs.scrollTop = logs.scrollHeight;
            })
            .catch(function (e) { });
    }

    document.getElementById('btn-start').addEventListener('click', function () {
        fetch('/ai/start', { method: 'POST' });
    });

    document.getElementById('btn-stop').addEventListener('click', function () {
        fetch('/ai/stop', { method: 'POST' });
    });

    document.getElementById('btn-set-task').addEventListener('click', function () {
        var task = document.getElementById('task-input').value;
        fetch('/ai/task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task: task })
        });
    });

    document.getElementById('btn-estop').addEventListener('click', function () {
        fetch('/emergency_stop', { method: 'POST' });
        alert('EMERGENCY STOP TRIGGERED');
    });

    setInterval(updateStatus, 500);
    setInterval(updateSlam, 1000);
    updateStatus();
    updateSlam();
</script>
{% endblock %}
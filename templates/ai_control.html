{% extends "base.html" %}

{% block title %}AI Agent{% endblock %}

{% block content %}
<div class="ai-layout">
    <div class="ai-video">
        <img src="/ai_video_feed" style="width: 100%; height: 100%; object-fit: contain;"
            alt="Robot View (CV Processed)">
        <div
            style="position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1);">
            <div class="status-indicator" style="padding: 0; background: none;">
                <div id="ai-status-dot" class="status-dot"></div>
                <span id="ai-status-text" class="status-text">Idle</span>
            </div>
        </div>
    </div>

    <div class="ai-controls">
        <div class="control-card" style="flex: 1; display: flex; flex-direction: column; gap: 15px;">
            <h3 style="color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase;">Task Control</h3>

            <textarea id="task-input" class="task-input" rows="3"
                style="width: 100%; padding: 10px; background: #000; border: 1px solid var(--border-color); color: #fff; border-radius: 6px; resize: none;"
                placeholder="Enter task... (e.g., 'go through the door')"></textarea>

            <button id="btn-set-task" class="btn"
                style="background: var(--bg-panel); border: 1px solid var(--border-color); color: var(--text-secondary);">Set
                Task</button>

            <div style="display: flex; gap: 10px; margin-top: auto;">
                <button id="btn-start" class="btn btn-primary" style="flex: 1; justify-content: center;">Start
                    AI</button>
                <button id="btn-stop" class="btn btn-danger" style="flex: 1; justify-content: center;">Pause AI</button>
            </div>

            <button id="btn-estop" class="btn btn-danger"
                style="width: 100%; justify-content: center; font-weight: bold; margin-top: 10px;">
                EMERGENCY STOP
            </button>
        </div>



        <div class="control-card" style="flex: 1; display: flex; flex-direction: column;">
            <h3 style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 10px;">System Logs</h3>
            <div class="log-window" id="log-window" style="flex: 1; height: auto;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>


    function updateStatus() {
        fetch('/ai/status')
            .then(function (r) { return r.json(); })
            .then(function (data) {
                var dot = document.getElementById('ai-status-dot');
                var text = document.getElementById('ai-status-text');
                var logs = document.getElementById('log-window');

                if (data.enabled) {
                    dot.className = 'status-dot active';
                    text.textContent = 'Running: ' + data.status;
                } else {
                    dot.className = 'status-dot';
                    text.textContent = 'Stopped: ' + data.status;
                }

                var html = '';
                for (var i = 0; i < data.logs.length; i++) {
                    html += '<div class="log-entry">' + data.logs[i] + '</div>';
                }
                logs.innerHTML = html;
                logs.scrollTop = logs.scrollHeight;
            })
            .catch(function (e) { });
    }

    document.getElementById('btn-start').addEventListener('click', function () {
        fetch('/ai/start', { method: 'POST' });
    });

    document.getElementById('btn-stop').addEventListener('click', function () {
        fetch('/ai/stop', { method: 'POST' });
    });

    document.getElementById('btn-set-task').addEventListener('click', function () {
        var task = document.getElementById('task-input').value;
        fetch('/ai/task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task: task })
        });
    });

    document.getElementById('btn-estop').addEventListener('click', function () {
        fetch('/emergency_stop', { method: 'POST' });
        alert('EMERGENCY STOP TRIGGERED');
    });

    setInterval(updateStatus, 500);

</script>
{% endblock %}
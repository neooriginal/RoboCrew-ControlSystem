{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard-grid">

    <!-- Status Card -->
    <div class="control-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h3 style="color: var(--text-secondary); font-size: 0.85rem; letter-spacing: 1.5px; font-weight: 600;">
                SYSTEM STATUS</h3>
            <div class="status-dot active" style="width: 6px; height: 6px;"></div>
        </div>

        <div style="display: grid; gap: 12px;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid rgba(255,255,255,0.02);">
                <span style="font-weight: 500;">Controller</span>
                <span id="status-controller" class="status-dot"></span>
            </div>
            <div
                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid rgba(255,255,255,0.02);">
                <span style="font-weight: 500;">Camera</span>
                <span id="status-camera" class="status-dot"></span>
            </div>
            <div
                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid rgba(255,255,255,0.02);">
                <span style="font-weight: 500;">Arm</span>
                <span id="status-arm" class="status-dot"></span>
            </div>
            <div
                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid rgba(255,255,255,0.02);">
                <span style="font-weight: 500;">Active Mode</span>
                <span id="status-mode"
                    style="color: var(--primary); font-weight: 700; text-shadow: 0 0 10px rgba(0, 242, 255, 0.4);">LOADING...</span>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="control-card" style="display: flex; flex-direction: column;">
        <h3
            style="margin-bottom: 25px; color: var(--text-secondary); font-size: 0.85rem; letter-spacing: 1.5px; font-weight: 600;">
            QUICK ACTIONS</h3>

        <div style="display: grid; grid-template-columns: 1fr; gap: 15px; flex: 1;">
            <button class="btn btn-primary" style="justify-content: center; height: 50px;"
                onclick="fetch('/arm/home', {method: 'POST'})">
                <span style="font-size: 1.2rem;">ðŸ¦¾</span> Home Arm
            </button>

            <button class="btn btn-danger"
                style="justify-content: center; height: 60px; margin-top: auto; font-weight: 800; letter-spacing: 1px;"
                onclick="fetch('/emergency_stop', {method: 'POST'})">
                ðŸ›‘ EMERGENCY STOP
            </button>
        </div>
    </div>

    <!-- Live Camera Feed -->
    <div class="control-card" style="grid-column: span 2;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: var(--text-secondary); font-size: 0.85rem; letter-spacing: 1.5px; font-weight: 600;">
                VISUAL UPLINK</h3>
            <div id="status-uplink" class="status-dot" style="width: 8px; height: 8px;"></div>
        </div>
        <div
            style="background: #000; border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color); aspect-ratio: 16/9;">
            <img src="/video_feed" style="width: 100%; height: 100%; object-fit: cover;" alt="Live Feed">
        </div>
    </div>

    <!-- Terminal Log -->
    <div class="control-card" style="grid-column: 1 / -1;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: var(--text-secondary); font-size: 0.85rem; letter-spacing: 1.5px; font-weight: 600;">
                NEURAL LINK ACTIVITY</h3>
            <span style="font-size: 0.8rem; color: var(--text-secondary); opacity: 0.5;">LIVE FEED</span>
        </div>

        <div class="log-window" id="mini-log" style="height: 200px;">
            <div class="log-entry" style="color: var(--text-secondary);">Initializing neural link...</div>
        </div>
    </div>
</div>

<script>
    // Poll for status updates on the dashboard (System Status)
    setInterval(async () => {
        try {
            const res = await fetch('/display/state');
            const data = await res.json();

            // Update status dots
            const setStatus = (id, active) => {
                const el = document.getElementById(id);
                if (el) {
                    el.className = 'status-dot ' + (active ? 'active' : 'error');
                }
            };

            setStatus('status-controller', data.controller_connected);
            setStatus('status-camera', data.camera_connected);
            setStatus('status-uplink', data.camera_connected); // Link uplink to camera
            setStatus('status-arm', data.arm_connected);

            const modeEl = document.getElementById('status-mode');
            if (modeEl) modeEl.textContent = (data.control_mode || 'IDLE').toUpperCase();

        } catch (e) { }
    }, 1000);

    // Listen for log updates from the global LogManager (notifications.js)
    document.addEventListener('log-update', (e) => {
        const logs = e.detail;
        const logDiv = document.getElementById('mini-log');
        if (!logDiv) return;

        // Clear "Initializing..." message if present
        if (logDiv.children.length === 1 && logDiv.firstElementChild.textContent.includes('Initializing')) {
            logDiv.innerHTML = '';
        }

        // Prepend new logs
        logs.forEach(log => {
            const entry = document.createElement('div');
            entry.className = 'log-entry';

            // Format: [10:00:00] [INFO] Message ...
            entry.innerHTML = `
                <span class="log-timestamp">[${log.timestamp}]</span>
                <span class="log-level ${log.level}">${log.level}</span>
                <span class="log-message">${escapeHtml(log.message)}</span>
            `;

            logDiv.prepend(entry);
        });

        // Limit history to 50 items
        while (logDiv.children.length > 50) {
            logDiv.lastElementChild.remove();
        }
    });

    function escapeHtml(text) {
        if (!text) return '';
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
</script>
{% endblock %}
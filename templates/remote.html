{% extends "base.html" %}

{% block title %}Remote Control{% endblock %}

{% block actions %}
<!-- TTS & Speed Controls -->
<div class="remote-actions" style="display: flex; align-items: center; gap: 10px;">
    <div
        style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 6px; white-space: nowrap;">
        <label style="font-size: 0.8em; color: #aaa; margin: 0;">üîä TTS</label>
        <input type="text" id="tts-text" placeholder="Speak..."
            style="padding: 4px 8px; background: #1a1a1a; border: 1px solid #444; border-radius: 3px; color: white; font-size: 0.75em; width: 120px;">
        <button id="tts-speak-btn" class="btn btn-primary" style="padding: 4px 10px; font-size: 0.75em;">Speak</button>
    </div>
    <div
        style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 6px;">
        <label style="font-size: 0.7em; color: #888; margin: 0;">üöó Speed:</label>
        <input type="range" id="wheel-speed" min="1000" max="20000" value="10000" step="100"
            style="width: 100px; accent-color: var(--warning);">
        <span id="wheel-speed-value"
            style="font-size: 0.7em; color: #aaa; min-width: 40px; font-weight: bold;">10000</span>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="panels">
    <!-- Touch Controls Layer (Mobile Only) -->
    <div class="touch-controls-layer">
        <div id="joystick-left" class="joystick-zone"></div>
        <div id="joystick-right" class="joystick-zone"></div>

        <!-- Mobile Action Buttons -->
        <div class="mobile-actions">
            <!-- Arm controls removed per user request (Wheels only) -->
        </div>
    </div>

    <!-- Drive Mode Panel (Left) -->
    <div class="panel drive-panel" id="drive-panel">
        <div class="panel-header">
            <span class="panel-icon">üöó</span>
            <span class="panel-title">Drive</span>
            <div class="mode-indicator" id="drive-indicator"></div>
        </div>
        <div class="video-container" id="video-container">
            <img id="video-feed" src="/video_feed" alt="Robot Camera Feed">
            <div class="video-overlay"></div>

            <div class="crosshair">
                <div class="crosshair-ring">
                    <div class="crosshair-dot"></div>
                </div>
                <div class="crosshair-line h left"></div>
                <div class="crosshair-line h right"></div>
                <div class="crosshair-line v top"></div>
                <div class="crosshair-line v bottom"></div>
            </div>

            <div class="click-prompt" id="drive-prompt">
                <h2>üñ±Ô∏è Click to Drive</h2>
                <p>Mouse controls head ‚Ä¢ WASD moves robot</p>
            </div>

            <!-- Status overlay -->
            <div class="status-overlay">
                <div class="status-dot" id="status-dot"></div>
                <span class="status-text" id="status-text">Loading...</span>
            </div>

            <!-- Body direction compass -->
            <div class="body-compass">
                <div class="compass-ring">
                    <span class="compass-n">‚ñ≤</span>
                    <div class="compass-arrow" id="compass-arrow"></div>
                    <div class="compass-center"></div>
                </div>
                <span class="compass-label">Body ‚Üí</span>
            </div>
        </div>
    </div>

    <!-- Arm Mode Panel (Right) -->
    <div class="panel arm-panel" id="arm-panel">
        <div class="panel-header">
            <span class="panel-icon">ü¶æ</span>
            <span class="panel-title">Arm</span>
            <div class="mode-indicator" id="arm-indicator"></div>
        </div>
        <div class="arm-container" id="arm-container">
            <!-- Arm visualization -->
            <div class="arm-visual">
                <svg viewBox="0 0 200 200" class="arm-svg">
                    <!-- Base -->
                    <circle cx="100" cy="180" r="20" class="arm-base" />
                    <!-- Upper arm -->
                    <line id="arm-upper" x1="100" y1="180" x2="100" y2="120" class="arm-segment" />
                    <!-- Forearm -->
                    <line id="arm-forearm" x1="100" y1="120" x2="100" y2="60" class="arm-segment" />
                    <!-- Wrist -->
                    <line id="arm-wrist" x1="100" y1="60" x2="100" y2="40" class="arm-segment arm-wrist" />
                    <!-- Gripper -->
                    <g id="arm-gripper" transform="translate(100, 30)">
                        <line x1="-8" y1="0" x2="-8" y2="15" class="gripper-finger" />
                        <line x1="8" y1="0" x2="8" y2="15" class="gripper-finger" />
                    </g>
                    <!-- Joints -->
                    <circle cx="100" cy="180" r="6" class="arm-joint" />
                    <circle cx="100" cy="120" r="5" class="arm-joint" />
                    <circle cx="100" cy="60" r="4" class="arm-joint" />
                </svg>

                <!-- Arm position display -->
                <div class="arm-info">
                    <div class="arm-stat">
                        <span class="stat-label">Pan</span>
                        <span class="stat-value" id="arm-pan">0¬∞</span>
                    </div>
                    <div class="arm-stat">
                        <span class="stat-label">Reach</span>
                        <span class="stat-value" id="arm-reach">0¬∞</span>
                    </div>
                    <div class="arm-stat">
                        <span class="stat-label">Wrist</span>
                        <span class="stat-value" id="arm-wrist-val">0¬∞</span>
                    </div>
                </div>
            </div>

            <div class="click-prompt" id="arm-prompt">
                <h2>üñ±Ô∏è Click to Control Arm</h2>
                <p>Mouse moves arm ‚Ä¢ Scroll rotates wrist</p>
                <p class="sub">Hold click to close gripper</p>
            </div>

            <!-- Arm controls hint -->
            <div class="arm-controls-hint">
                <div class="hint-row">
                    <kbd>Q</kbd><kbd>E</kbd> Rotate base
                </div>
                <div class="hint-row">
                    <kbd>T</kbd><kbd>G</kbd> Elbow
                </div>
                <div class="hint-row">
                    <kbd>R</kbd><kbd>F</kbd> Wrist flex
                </div>

            </div>
        </div>
    </div>
</div>

<div class="debug-panel" id="debug-panel"></div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
<script>
    // Mobile Touch Control Logic
    document.addEventListener('DOMContentLoaded', () => {
        // Only initialize on touch devices or small screens
        if (window.innerWidth > 768 && !('ontouchstart' in window)) return;

        console.log('Initializing Mobile Controls');

        // Left Joystick - Drive (WASD)
        const driveManager = nipplejs.create({
            zone: document.getElementById('joystick-left'),
            mode: 'static',
            position: { left: '80px', bottom: '160px' },
            color: 'cyan',
            size: 100
        });

        // Right Joystick - Head (Mouse Look)
        const headManager = nipplejs.create({
            zone: document.getElementById('joystick-right'),
            mode: 'static',
            position: { right: '80px', bottom: '160px' },
            color: 'magenta',
            size: 100
        });

        // Drive Logic
        driveManager.on('move', (evt, data) => {
            if (!data.vector) return;

            // Map vector to WASD keys globally defined in app.js
            // Thresholds for directional activation
            const threshold = 0.3;
            const x = data.vector.x;
            const y = data.vector.y;

            // Update global keysPressed object from app.js
            if (typeof keysPressed !== 'undefined') {
                keysPressed.w = y > threshold;
                keysPressed.s = y < -threshold;
                keysPressed.a = x < -threshold;
                keysPressed.d = x > threshold; // Fixed: d is positive x

                // Trigger movement update
                if (typeof sendMovement === 'function') sendMovement();
            }
        });

        driveManager.on('end', () => {
            if (typeof keysPressed !== 'undefined') {
                keysPressed.w = false;
                keysPressed.s = false;
                keysPressed.a = false;
                keysPressed.d = false;
                if (typeof sendMovement === 'function') sendMovement();
            }
        });

        // Head Logic
        let headInterval;
        headManager.on('move', (evt, data) => {
            if (!data.vector) return;

            // Continuous update while holding
            clearInterval(headInterval);
            headInterval = setInterval(() => {
                if (typeof currentYaw !== 'undefined' && typeof currentPitch !== 'undefined') {
                    // Adjust sensitivity here
                    const sensitivity = 2.0;
                    const deltaYaw = data.vector.x * sensitivity;
                    const deltaPitch = -data.vector.y * sensitivity; // Invert Y for natural look

                    currentYaw = Math.max(YAW_MIN, Math.min(YAW_MAX, currentYaw + deltaYaw));
                    currentPitch = Math.max(PITCH_MIN, Math.min(PITCH_MAX, currentPitch + deltaPitch));

                    if (typeof updateCompass === 'function') updateCompass();
                    if (typeof scheduleHeadUpdate === 'function') scheduleHeadUpdate();
                }
            }, 33); // ~30fps
        });

        headManager.on('end', () => {
            clearInterval(headInterval);
        });

        // Mobile Buttons
        const gripBtn = document.getElementById('btn-mobile-gripper');
        if (gripBtn) {
            gripBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (typeof setGripper === 'function') setGripper(true);
                gripBtn.classList.add('active');
            });
            gripBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (typeof setGripper === 'function') setGripper(false);
                gripBtn.classList.remove('active');
            });
        }

        const modeBtn = document.getElementById('btn-toggle-arm');
        if (modeBtn) {
            modeBtn.addEventListener('click', () => {
                // Toggle between drive/arm modes if needed, currently sets focus
                // For now, mobile assumes 'drive' mode mostly, but we can toggle view
                if (typeof setMode === 'function') {
                    const newMode = (currentMode === 'drive') ? 'arm' : 'drive';
                    setMode(newMode);
                }
            });
        }

        // Force Drive Mode on touch interaction start if not set
        document.getElementById('joystick-left').addEventListener('touchstart', () => {
            if (currentMode !== 'drive' && typeof setMode === 'function') setMode('drive');
        });
    });
</script>
{% endblock %}